<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Memory Detail | SmritiKosha</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    };
  </script>
</head>
<body class="bg-white font-sans text-gray-800">
  <!-- Navbar -->
  <nav class="sticky top-0 bg-white shadow-sm z-50 px-6 py-4 flex items-center justify-between">
    <button onclick="history.back()" class="text-indigo-600 hover:text-indigo-800 font-medium">&larr; Back</button>
    <span class="text-sm text-gray-400">Memory View</span>
  </nav>

  <!-- Hero Image -->
  <div class="max-w-5xl mx-auto p-6">
    <img id="hero-image" src="" alt="Hero Image" class="w-full rounded-xl shadow-md object-cover max-h-[400px]" />

    <!-- Meta -->
    <div class="mt-6">
      <h1 id="memory-title" class="text-3xl font-bold text-indigo-700 mb-2">Memory Title</h1>
      <div class="flex items-center text-sm text-gray-500 mb-2">
        <span id="memory-location" class="mr-4">üìç Location</span>
        <span id="memory-timestamp">üïì Date</span>
      </div>
      <p id="memory-description" class="text-gray-700 text-base leading-relaxed mt-4">
        This is a personal note or description associated with the memory. Could be a short journal entry or message.
      </p>
    </div>

    <!-- Action buttons -->
    <div class="mt-6 flex gap-3">
      <button id="edit-memory" class="text-sm px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Edit</button>
      <button id="delete-memory" class="text-sm px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Delete</button>
      <button id="add-image" class="text-sm px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Add Image</button>
    </div>

    <!-- Image Gallery -->
    <div id="gallery" class="mt-8 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
      <!-- Images inserted dynamically here -->
    </div>
  </div>

  <script type="module">
    import { supabase } from '../lib/supabaseClient.js';

    const params = new URLSearchParams(window.location.search);
    const memoryId = params.get('id');

    async function loadMemoryDetails() {
      const { data: memory } = await supabase.from('memories').select('*').eq('id', memoryId).single();
      const { data: images } = await supabase.from('memory_images').select('*').eq('memory_id', memoryId);

      document.getElementById('memory-title').textContent = memory.title;
      document.getElementById('memory-location').textContent = memory.location || '';
      document.getElementById('memory-timestamp').textContent = new Date(memory.created_at).toLocaleDateString();
      document.getElementById('memory-description').textContent = memory.description || '';

      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';

      for (let i = 0; i < images.length; i++) {
        const { data: urlData } = await supabase.storage.from('memory-images').createSignedUrl(images[i].image_path, 3600);
        const img = document.createElement('img');
        img.src = urlData?.signedUrl || '';
        img.className = 'rounded-lg object-cover h-40 w-full cursor-pointer hover:scale-105 transition';
        gallery.appendChild(img);
      }

      document.getElementById('hero-image').src = gallery.firstChild?.src || '';
    }

    document.getElementById('delete-memory').addEventListener('click', async () => {
      if (confirm('Are you sure you want to delete this memory?')) {
        await supabase.from('memory_images').delete().eq('memory_id', memoryId);
        await supabase.from('memories').delete().eq('id', memoryId);
        window.location.href = './main.html';
      }
    });

    document.getElementById('edit-memory').addEventListener('click', () => {
      window.location.href = `./edit.html?id=${memoryId}`;
    });

    document.getElementById('add-image').addEventListener('click', () => {
      window.location.href = `./add-image.html?id=${memoryId}`;
    });

    loadMemoryDetails();
  </script>
</body>
</html>
